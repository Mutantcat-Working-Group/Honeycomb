name: Windows MinGW (Qt 6.10.1 | CMake)

on:
  push:
    paths:
      - 'CMakeLists.txt'
      - 'src/**'
      - '.github/workflows/windows-mingw-6.10.1.yml'
  pull_request:
    paths:
      - 'CMakeLists.txt'
      - 'src/**'
      - '.github/workflows/windows-mingw-6.10.1.yml'

jobs:
  build:
    name: Build
    runs-on: windows-2019
    strategy:
      matrix:
        include:
          - qt_arch: win64_mingw_11.2.0
            qt_ver: 6.10.1
            qt_tools: "tools_mingw,11.2.0-1,qt.tools.win64_mingw1120"
            qt_tools_mingw_install: mingw1120_64
    env:
      targetName: appHoneycomb.exe
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt 6.10.1 (在线安装器)
        uses: jurplel/install-qt-action@v4
        with:
          version:        ${{ matrix.qt_ver }}
          arch:           ${{ matrix.qt_arch }}
          tools:          ${{ matrix.qt_tools }}
          modules:        'qtquickcontrols2 qtquicktimeline qtsvg'
          install-deps:   true
          cache:          true
          use-official:   true          # 绕过离线包缺失

      - name: Configure PATH
        shell: pwsh
        run: |
          Write-Output "${{ env.Qt6_DIR }}\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Output "${{ env.Qt6_DIR }}\..\..\Tools\${{ matrix.qt_tools_mingw_install }}\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure & Build
        shell: cmd
        run: |
          cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Conan 三方库导出（可选）
        run: |
          conan install . --deployer=full_deploy -s build_type=Release --build=missing

      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force app
          Copy-Item build\Release\${env:targetName} app\
          windeployqt app\${env:targetName} --qmldir $env:Qt6_DIR\qml --release
          # 复制 Conan DLL（若启用）
          Copy-Item full_deploy\host\*\Release\*\bin\*.dll app\ -ErrorAction SilentlyContinue
          7z a Honeycomb-win-6.10.1.zip app\

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Honeycomb-win-6.10.1
          path: Honeycomb-win-6.10.1.zip

      - name: Upload Release
        if: startsWith(github.event.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: Honeycomb-win-6.10.1.zip
          asset_name: Honeycomb-win-6.10.1.zip
          tag: ${{ github.ref }}
          overwrite: true
