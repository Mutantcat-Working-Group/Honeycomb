name: Windows MinGW (Qt 6.10.1 | CMake)

on:
  push:
    paths:
      - 'CMakeLists.txt'
      - 'src/**'
      - '.github/workflows/windows-mingw-6.10.1.yml'
  pull_request:
    paths:
      - 'CMakeLists.txt'
      - 'src/**'
      - '.github/workflows/windows-mingw-6.10.1.yml'
  # ğŸ‘‡ æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: windows-2019
    env:
      targetName: appHoneycomb.exe
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt 6.10.1 (åœ¨çº¿å®‰è£…å™¨)
        uses: jurplel/install-qt-action@v4
        with:
          version:        '6.10.1'
          arch:           'win64_mingw_11.2.0'
          tools:          'tools_mingw,11.2.0-1,qt.tools.win64_mingw1120'
          modules:        'qtquickcontrols2 qtquicktimeline qtsvg'
          install-deps:   true
          cache:          true
          use-official:   true          # å…³é”®ï¼šç»•è¿‡ç¦»çº¿åŒ…ç¼ºå¤±

      - name: Configure PATH
        shell: pwsh
        run: |
          Write-Output "${{ env.Qt6_DIR }}\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Output "${{ env.Qt6_DIR }}\..\..\Tools\mingw1120_64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure & Build
        shell: cmd
        run: |
          cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Conan ä¸‰æ–¹åº“å¯¼å‡ºï¼ˆå¯é€‰ï¼‰
        run: |
          conan install . --deployer=full_deploy -s build_type=Release --build=missing

      - name: Package
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force app
          Copy-Item build\Release\${env:targetName} app\
          windeployqt app\${env:targetName} --qmldir $env:Qt6_DIR\qml --release
          Copy-Item full_deploy\host\*\Release\*\bin\*.dll app\ -ErrorAction SilentlyContinue
          7z a Honeycomb-win-6.10.1.zip app\

      - uses: actions/upload-artifact@v4
        with:
          name: Honeycomb-win-6.10.1
          path: Honeycomb-win-6.10.1.zip

      - name: Upload Release
        if: startsWith(github.event.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: Honeycomb-win-6.10.1.zip
          asset_name: Honeycomb-win-6.10.1.zip
          tag: ${{ github.ref }}
          overwrite: true
